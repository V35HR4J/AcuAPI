#!/bin/bash

# AcuAPI - Acunetix CLI Tool v2.0
# A scalable command-line interface for Acunetix vulnerability scanner

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/config.json"
VERSION="2.0.0"

# Global options
OUTPUT_FORMAT="pretty"  # pretty, json, csv
OUTPUT_FILE=""
QUIET=false
VERBOSE=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# ============== UTILITIES ==============

# Log functions
log_error() { [[ "$QUIET" != true ]] && echo -e "${RED}[ERROR]${NC} $1" >&2; }
log_success() { [[ "$QUIET" != true ]] && echo -e "${GREEN}[OK]${NC} $1"; }
log_info() { [[ "$QUIET" != true ]] && echo -e "${BLUE}[INFO]${NC} $1"; }
log_warn() { [[ "$QUIET" != true ]] && echo -e "${YELLOW}[WARN]${NC} $1"; }
log_debug() { [[ "$VERBOSE" == true ]] && echo -e "${MAGENTA}[DEBUG]${NC} $1"; }

# Output handler - routes to file, stdout, or formats as needed
output() {
    local data="$1"
    local formatted="$2"  # Optional formatted version for pretty output
    
    if [[ -n "$OUTPUT_FILE" ]]; then
        echo "$data" > "$OUTPUT_FILE"
        log_info "Output saved to: $OUTPUT_FILE"
    elif [[ "$OUTPUT_FORMAT" == "json" ]]; then
        echo "$data" | jq .
    elif [[ "$OUTPUT_FORMAT" == "csv" ]]; then
        echo "$data"
    else
        # Pretty format
        if [[ -n "$formatted" ]]; then
            echo -e "$formatted"
        else
            echo "$data" | jq .
        fi
    fi
}

# Load configuration
load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_error "Config file not found at $CONFIG_FILE"
        exit 1
    fi
    
    API_URL=$(jq -r '.url' "$CONFIG_FILE")
    API_KEY=$(jq -r '.api_key' "$CONFIG_FILE")
    
    if [[ -z "$API_URL" || -z "$API_KEY" || "$API_URL" == "null" ]]; then
        log_error "Invalid configuration"
        exit 1
    fi
    
    log_debug "Loaded config: $API_URL"
}

# API request helper with better error handling
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    
    local url="${API_URL}/api/v1${endpoint}"
    
    log_debug "API $method $endpoint"
    
    local curl_opts=(
        -s
        -k
        -w "\n%{http_code}"
        -X "$method"
        -H "X-Auth: $API_KEY"
        -H "Content-Type: application/json"
    )
    
    if [[ -n "$data" ]]; then
        curl_opts+=(-d "$data")
        log_debug "Request body: $data"
    fi
    
    local response
    response=$(curl "${curl_opts[@]}" "$url")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | sed '$d')
    
    log_debug "Response code: $http_code"
    
    if [[ "$http_code" -ge 400 ]]; then
        log_error "API returned $http_code"
        echo "$body"
        return 1
    fi
    
    echo "$body"
}

# Print formatted header (only in pretty mode)
print_header() {
    if [[ "$OUTPUT_FORMAT" == "pretty" && "$QUIET" != true ]]; then
        echo -e "\n${CYAN}╔════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║${NC}  ${BLUE}$1${NC}"
        echo -e "${CYAN}╚════════════════════════════════════════════╝${NC}\n"
    fi
}

# Get profile ID from name
get_profile_id() {
    local profile="$1"
    case "$profile" in
        "Full Scan"|"full"|"")
            echo "11111111-1111-1111-1111-111111111111" ;;
        "High Risk"|"high")
            echo "11111111-1111-1111-1111-111111111112" ;;
        "XSS"|"xss")
            echo "11111111-1111-1111-1111-111111111116" ;;
        "SQL Injection"|"sqli")
            echo "11111111-1111-1111-1111-111111111113" ;;
        "Weak Passwords"|"passwords")
            echo "11111111-1111-1111-1111-111111111115" ;;
        "Crawl Only"|"crawl")
            echo "11111111-1111-1111-1111-111111111117" ;;
        *)
            echo "11111111-1111-1111-1111-111111111111" ;;
    esac
}

# ============== TARGETS ==============

targets_list() {
    print_header "Targets List"
    
    local response=$(api_request GET "/targets")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    elif [[ "$OUTPUT_FORMAT" == "csv" ]]; then
        echo "target_id,address,description,criticality,fqdn"
        echo "$response" | jq -r '.targets[] | [.target_id, .address, (.description // ""), (.criticality // ""), (.fqdn // "")] | @csv'
    else
        local formatted=$(echo "$response" | jq -r '
            .targets[] | 
            "  \u001b[33m\(.target_id)\u001b[0m\n  Address: \(.address)\n  Description: \(.description // "N/A")\n  Criticality: \(.criticality // "N/A")\n  ─────────────────────────────────────"
        ')
        local count=$(echo "$response" | jq '.targets | length')
        output "$response" "$formatted\n\n${GREEN}Total targets: $count${NC}"
    fi
}

targets_add() {
    local address="$1"
    local description="${2:-}"
    local criticality="${3:-10}"
    
    if [[ -z "$address" ]]; then
        log_error "Target address is required"
        echo "Usage: acunetix targets add <url> [description] [criticality]"
        exit 1
    fi
    
    print_header "Adding Target"
    
    local data=$(jq -n \
        --arg addr "$address" \
        --arg desc "$description" \
        --argjson crit "$criticality" \
        '{address: $addr, description: $desc, criticality: $crit}')
    
    local response=$(api_request POST "/targets" "$data")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        local target_id=$(echo "$response" | jq -r '.target_id // empty')
        if [[ -n "$target_id" ]]; then
            log_success "Target added: $target_id"
            output "$response"
        else
            log_error "Failed to add target"
            echo "$response" | jq .
        fi
    fi
}

targets_info() {
    local target_id="$1"
    [[ -z "$target_id" ]] && { log_error "Target ID required"; exit 1; }
    
    print_header "Target Information"
    local response=$(api_request GET "/targets/$target_id")
    output "$response"
}

targets_delete() {
    local target_id="$1"
    [[ -z "$target_id" ]] && { log_error "Target ID required"; exit 1; }
    
    api_request DELETE "/targets/$target_id" > /dev/null
    log_success "Target deleted: $target_id"
}

# Bulk add targets from file
targets_import() {
    local file="$1"
    [[ -z "$file" || ! -f "$file" ]] && { log_error "File required"; exit 1; }
    
    print_header "Importing Targets"
    
    local count=0
    local failed=0
    
    while IFS= read -r url || [[ -n "$url" ]]; do
        [[ -z "$url" || "$url" =~ ^# ]] && continue
        
        local data=$(jq -n --arg addr "$url" '{address: $addr, criticality: 10}')
        if api_request POST "/targets" "$data" > /dev/null 2>&1; then
            ((count++))
            log_success "Added: $url"
        else
            ((failed++))
            log_error "Failed: $url"
        fi
    done < "$file"
    
    log_info "Import complete: $count added, $failed failed"
}

# ============== SCANS ==============

scans_list() {
    print_header "Scans List"
    
    local response=$(api_request GET "/scans")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    elif [[ "$OUTPUT_FORMAT" == "csv" ]]; then
        echo "scan_id,target_address,status,progress,profile,critical,high,medium,low"
        echo "$response" | jq -r '.scans[] | [
            .scan_id,
            (.target.address // ""),
            (.current_session.status // ""),
            (.current_session.progress // 0),
            (.profile_name // ""),
            (.current_session.severity_counts.critical // 0),
            (.current_session.severity_counts.high // 0),
            (.current_session.severity_counts.medium // 0),
            (.current_session.severity_counts.low // 0)
        ] | @csv'
    else
        local formatted=$(echo "$response" | jq -r '
            .scans[] | 
            "  \u001b[33m\(.scan_id)\u001b[0m
  Target: \(.target.address // "N/A")
  Status: \(.current_session.status // "N/A") (\(.current_session.progress // 0)%)
  Profile: \(.profile_name // "N/A")
  Vulns: C:\(.current_session.severity_counts.critical // 0) H:\(.current_session.severity_counts.high // 0) M:\(.current_session.severity_counts.medium // 0) L:\(.current_session.severity_counts.low // 0)
  ─────────────────────────────────────"
        ')
        local count=$(echo "$response" | jq '.scans | length')
        output "$response" "$formatted\n\n${GREEN}Total scans: $count${NC}"
    fi
}

scans_start() {
    local target_id="$1"
    local profile="${2:-full}"
    
    [[ -z "$target_id" ]] && { log_error "Target ID required"; exit 1; }
    
    print_header "Starting Scan"
    
    local profile_id=$(get_profile_id "$profile")
    
    local data=$(jq -n \
        --arg tid "$target_id" \
        --arg pid "$profile_id" \
        '{target_id: $tid, profile_id: $pid, schedule: {disable: false, start_date: null, time_sensitive: false}}')
    
    local response=$(api_request POST "/scans" "$data")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        local scan_id=$(echo "$response" | jq -r '.scan_id // empty')
        if [[ -n "$scan_id" ]]; then
            log_success "Scan started: $scan_id"
            echo "$scan_id"
        else
            log_error "Failed to start scan"
            echo "$response" | jq .
        fi
    fi
}

scans_status() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    print_header "Scan Status"
    
    local response=$(api_request GET "/scans/$scan_id")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        echo "$response" | jq -r '
            "Scan ID: \(.scan_id)
Target: \(.target.address // "N/A")
Profile: \(.profile_name // "N/A")
Status: \(.current_session.status // "N/A")
Progress: \(.current_session.progress // 0)%
Start Time: \(.current_session.start_date // "N/A")
Severity Counts:
  Critical: \(.current_session.severity_counts.critical // 0)
  High: \(.current_session.severity_counts.high // 0)
  Medium: \(.current_session.severity_counts.medium // 0)
  Low: \(.current_session.severity_counts.low // 0)
  Info: \(.current_session.severity_counts.info // 0)"
        '
    fi
}

scans_stop() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    api_request POST "/scans/$scan_id/abort" > /dev/null
    log_success "Scan stopped: $scan_id"
}

scans_pause() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    api_request POST "/scans/$scan_id/pause" > /dev/null
    log_success "Scan paused: $scan_id"
}

scans_resume() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    api_request POST "/scans/$scan_id/resume" > /dev/null
    log_success "Scan resumed: $scan_id"
}

scans_delete() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    api_request DELETE "/scans/$scan_id" > /dev/null
    log_success "Scan deleted: $scan_id"
}

# Watch scan progress in real-time
scans_watch() {
    local scan_id="$1"
    local interval="${2:-5}"
    
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    echo -e "${CYAN}Watching scan: $scan_id (Ctrl+C to stop)${NC}\n"
    
    while true; do
        local response=$(api_request GET "/scans/$scan_id" 2>/dev/null)
        local status=$(echo "$response" | jq -r '.current_session.status // "unknown"')
        local progress=$(echo "$response" | jq -r '.current_session.progress // 0')
        local target=$(echo "$response" | jq -r '.target.address // "N/A"')
        local critical=$(echo "$response" | jq -r '.current_session.severity_counts.critical // 0')
        local high=$(echo "$response" | jq -r '.current_session.severity_counts.high // 0')
        local medium=$(echo "$response" | jq -r '.current_session.severity_counts.medium // 0')
        local low=$(echo "$response" | jq -r '.current_session.severity_counts.low // 0')
        
        # Progress bar
        local bar_width=30
        local filled=$((progress * bar_width / 100))
        local empty=$((bar_width - filled))
        local bar=$(printf "%${filled}s" | tr ' ' '█')$(printf "%${empty}s" | tr ' ' '░')
        
        # Clear and print
        echo -ne "\r\033[K"
        echo -e "Target: ${YELLOW}$target${NC}"
        echo -e "Status: ${GREEN}$status${NC}"
        echo -e "Progress: [${CYAN}$bar${NC}] ${progress}%"
        echo -e "Vulnerabilities: ${RED}C:$critical${NC} ${YELLOW}H:$high${NC} ${BLUE}M:$medium${NC} L:$low"
        
        if [[ "$status" == "completed" || "$status" == "aborted" || "$status" == "failed" ]]; then
            echo -e "\n${GREEN}Scan finished with status: $status${NC}"
            break
        fi
        
        sleep "$interval"
        # Move cursor up for refresh
        echo -ne "\033[5A"
    done
}

# Get scan results/statistics
scans_results() {
    local scan_id="$1"
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    print_header "Scan Results"
    
    local scan_response=$(api_request GET "/scans/$scan_id")
    local session_id=$(echo "$scan_response" | jq -r '.current_session.scan_session_id // empty')
    
    [[ -z "$session_id" ]] && { log_error "No scan session found"; exit 1; }
    
    local stats=$(api_request GET "/scans/$scan_id/results/$session_id/statistics")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$stats"
    else
        echo "$stats" | jq .
    fi
}

# ============== VULNERABILITIES ==============

vulns_list() {
    local scan_id="$1"
    local severity_filter="${2:-}"  # critical, high, medium, low, info
    
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    print_header "Vulnerabilities"
    
    local scan_response=$(api_request GET "/scans/$scan_id")
    local session_id=$(echo "$scan_response" | jq -r '.current_session.scan_session_id // empty')
    
    [[ -z "$session_id" ]] && { log_error "No scan session found"; exit 1; }
    
    local response=$(api_request GET "/scans/$scan_id/results/$session_id/vulnerabilities")
    
    # Apply severity filter if specified
    if [[ -n "$severity_filter" ]]; then
        response=$(echo "$response" | jq --arg sev "$severity_filter" '
            .vulnerabilities |= [.[] | select(.severity | ascii_downcase == ($sev | ascii_downcase))]
        ')
    fi
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    elif [[ "$OUTPUT_FORMAT" == "csv" ]]; then
        echo "vuln_id,severity,name,affects_url,confidence"
        echo "$response" | jq -r '.vulnerabilities[] | [
            .vuln_id,
            .severity,
            .vt_name,
            (.affects_url // ""),
            (.confidence // "")
        ] | @csv'
    else
        echo "$response" | jq -r '
            .vulnerabilities[] |
            "[\(.severity | ascii_upcase)] \(.vt_name)
  URL: \(.affects_url // "N/A")
  ID: \(.vuln_id)
  ─────────────────────────────────────"
        '
        local count=$(echo "$response" | jq '.vulnerabilities | length')
        echo -e "\n${GREEN}Total vulnerabilities: $count${NC}"
    fi
}

vulns_info() {
    local scan_id="$1"
    local vuln_id="$2"
    
    [[ -z "$scan_id" || -z "$vuln_id" ]] && { log_error "Scan ID and Vuln ID required"; exit 1; }
    
    print_header "Vulnerability Details"
    
    local scan_response=$(api_request GET "/scans/$scan_id")
    local session_id=$(echo "$scan_response" | jq -r '.current_session.scan_session_id // empty')
    
    local response=$(api_request GET "/scans/$scan_id/results/$session_id/vulnerabilities/$vuln_id")
    output "$response"
}

# Export vulnerabilities to various formats
vulns_export() {
    local scan_id="$1"
    local format="${2:-json}"
    local file="${3:-}"
    
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    local scan_response=$(api_request GET "/scans/$scan_id")
    local session_id=$(echo "$scan_response" | jq -r '.current_session.scan_session_id // empty')
    local target=$(echo "$scan_response" | jq -r '.target.address // "unknown"')
    
    [[ -z "$session_id" ]] && { log_error "No scan session found"; exit 1; }
    
    local response=$(api_request GET "/scans/$scan_id/results/$session_id/vulnerabilities")
    
    local output_data
    case "$format" in
        json)
            output_data=$(echo "$response" | jq '{
                scan_id: "'"$scan_id"'",
                target: "'"$target"'",
                exported_at: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
                vulnerabilities: .vulnerabilities
            }')
            ;;
        csv)
            output_data="vuln_id,severity,name,affects_url,description"$'\n'
            output_data+=$(echo "$response" | jq -r '.vulnerabilities[] | [
                .vuln_id,
                .severity,
                .vt_name,
                (.affects_url // ""),
                (.description // "" | gsub("\n"; " ") | gsub(","; ";"))
            ] | @csv')
            ;;
        markdown|md)
            output_data="# Vulnerability Report"$'\n'
            output_data+="**Target:** $target"$'\n'
            output_data+="**Scan ID:** $scan_id"$'\n'
            output_data+="**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)"$'\n\n'
            output_data+="## Findings"$'\n\n'
            output_data+=$(echo "$response" | jq -r '.vulnerabilities[] | 
                "### [\(.severity | ascii_upcase)] \(.vt_name)\n- **URL:** \(.affects_url // "N/A")\n- **ID:** \(.vuln_id)\n"')
            ;;
        *)
            log_error "Unknown format: $format (use json, csv, or markdown)"
            exit 1
            ;;
    esac
    
    if [[ -n "$file" ]]; then
        echo "$output_data" > "$file"
        log_success "Exported to: $file"
    else
        echo "$output_data"
    fi
}

# ============== REPORTS ==============

reports_list() {
    print_header "Reports List"
    
    local response=$(api_request GET "/reports")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        echo "$response" | jq -r '
            .reports[] | 
            "ID: \(.report_id)
Template: \(.template_name // "N/A")
Status: \(.status // "N/A")
Generated: \(.generation_date // "N/A")
─────────────────────────────────────"
        '
    fi
}

reports_generate() {
    local scan_id="$1"
    local template="${2:-developer}"
    
    [[ -z "$scan_id" ]] && { log_error "Scan ID required"; exit 1; }
    
    print_header "Generating Report"
    
    # Get template ID
    local template_id
    case "$template" in
        "developer"|"dev") template_id="11111111-1111-1111-1111-111111111111" ;;
        "executive"|"exec") template_id="11111111-1111-1111-1111-111111111112" ;;
        "quick") template_id="11111111-1111-1111-1111-111111111113" ;;
        "affected") template_id="11111111-1111-1111-1111-111111111114" ;;
        "hipaa") template_id="11111111-1111-1111-1111-111111111115" ;;
        "owasp2017") template_id="11111111-1111-1111-1111-111111111116" ;;
        "owasp2021") template_id="11111111-1111-1111-1111-111111111119" ;;
        "pci") template_id="11111111-1111-1111-1111-111111111117" ;;
        "sans") template_id="11111111-1111-1111-1111-111111111118" ;;
        *) template_id="11111111-1111-1111-1111-111111111111" ;;
    esac
    
    local data=$(jq -n \
        --arg tid "$template_id" \
        '{
            template_id: $tid,
            source: {
                list_type: "scans",
                id_list: ["'"$scan_id"'"]
            }
        }')
    
    local response=$(api_request POST "/reports" "$data")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        local report_id=$(echo "$response" | jq -r '.report_id // empty')
        if [[ -n "$report_id" ]]; then
            log_success "Report generation started: $report_id"
            echo "$report_id"
        else
            log_error "Failed to generate report"
            echo "$response" | jq .
        fi
    fi
}

reports_download() {
    local report_id="$1"
    local output_file="${2:-report_$(date +%Y%m%d_%H%M%S).pdf}"
    
    [[ -z "$report_id" ]] && { log_error "Report ID required"; exit 1; }
    
    local url="${API_URL}/api/v1/reports/${report_id}/download"
    
    curl -s -k -H "X-Auth: $API_KEY" -o "$output_file" "$url"
    
    if [[ -f "$output_file" && -s "$output_file" ]]; then
        log_success "Report downloaded: $output_file"
    else
        log_error "Failed to download report"
    fi
}

reports_delete() {
    local report_id="$1"
    [[ -z "$report_id" ]] && { log_error "Report ID required"; exit 1; }
    api_request DELETE "/reports/$report_id" > /dev/null
    log_success "Report deleted: $report_id"
}

# ============== QUICK SCAN ==============

quick_scan() {
    local address="$1"
    local profile="${2:-full}"
    local watch="${3:-}"
    
    [[ -z "$address" ]] && { log_error "Target URL required"; exit 1; }
    
    print_header "Quick Scan"
    
    # Add target
    log_info "Adding target: $address"
    local target_data=$(jq -n --arg addr "$address" '{address: $addr, criticality: 10}')
    local target_response=$(api_request POST "/targets" "$target_data")
    local target_id=$(echo "$target_response" | jq -r '.target_id // empty')
    
    [[ -z "$target_id" ]] && { log_error "Failed to add target"; exit 1; }
    log_success "Target added: $target_id"
    
    # Start scan
    log_info "Starting scan..."
    local profile_id=$(get_profile_id "$profile")
    local scan_data=$(jq -n \
        --arg tid "$target_id" \
        --arg pid "$profile_id" \
        '{target_id: $tid, profile_id: $pid, schedule: {disable: false, start_date: null, time_sensitive: false}}')
    
    local scan_response=$(api_request POST "/scans" "$scan_data")
    local scan_id=$(echo "$scan_response" | jq -r '.scan_id // empty')
    
    [[ -z "$scan_id" ]] && { log_error "Failed to start scan"; exit 1; }
    log_success "Scan started: $scan_id"
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        jq -n --arg tid "$target_id" --arg sid "$scan_id" '{target_id: $tid, scan_id: $sid}'
    else
        echo -e "\n${CYAN}Target ID:${NC} $target_id"
        echo -e "${CYAN}Scan ID:${NC}   $scan_id"
        echo -e "\nUse '${YELLOW}acunetix scans watch $scan_id${NC}' to monitor progress"
    fi
    
    # Auto-watch if requested
    if [[ "$watch" == "--watch" || "$watch" == "-w" ]]; then
        echo ""
        scans_watch "$scan_id"
    fi
}

# ============== RAW API ==============

# Direct API access for advanced users
api_raw() {
    local method="${1:-GET}"
    local endpoint="$2"
    local data="$3"
    
    [[ -z "$endpoint" ]] && { log_error "Endpoint required"; exit 1; }
    
    # Ensure endpoint starts with /
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    
    local response=$(api_request "$method" "$endpoint" "$data")
    echo "$response" | jq .
}

# ============== STATISTICS ==============

stats() {
    print_header "Statistics"
    
    local targets=$(api_request GET "/targets")
    local scans=$(api_request GET "/scans")
    
    local target_count=$(echo "$targets" | jq '.targets | length')
    local scan_count=$(echo "$scans" | jq '.scans | length')
    local running=$(echo "$scans" | jq '[.scans[] | select(.current_session.status == "processing")] | length')
    local completed=$(echo "$scans" | jq '[.scans[] | select(.current_session.status == "completed")] | length')
    
    # Count vulnerabilities across all completed scans
    local total_critical=0
    local total_high=0
    local total_medium=0
    local total_low=0
    
    while read -r counts; do
        local c=$(echo "$counts" | jq -r '.critical // 0')
        local h=$(echo "$counts" | jq -r '.high // 0')
        local m=$(echo "$counts" | jq -r '.medium // 0')
        local l=$(echo "$counts" | jq -r '.low // 0')
        ((total_critical += c)) || true
        ((total_high += h)) || true
        ((total_medium += m)) || true
        ((total_low += l)) || true
    done < <(echo "$scans" | jq -c '.scans[].current_session.severity_counts // {}')
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        jq -n \
            --argjson targets "$target_count" \
            --argjson scans "$scan_count" \
            --argjson running "$running" \
            --argjson completed "$completed" \
            --argjson critical "$total_critical" \
            --argjson high "$total_high" \
            --argjson medium "$total_medium" \
            --argjson low "$total_low" \
            '{
                targets: $targets,
                scans: {total: $scans, running: $running, completed: $completed},
                vulnerabilities: {critical: $critical, high: $high, medium: $medium, low: $low}
            }'
    else
        echo -e "${CYAN}Targets:${NC}      $target_count"
        echo -e "${CYAN}Scans:${NC}        $scan_count (Running: $running, Completed: $completed)"
        echo -e "${CYAN}Vulnerabilities:${NC}"
        echo -e "  ${RED}Critical:${NC}   $total_critical"
        echo -e "  ${YELLOW}High:${NC}       $total_high"
        echo -e "  ${BLUE}Medium:${NC}     $total_medium"
        echo -e "  Low:        $total_low"
    fi
}

# ============== MISC ==============

profiles_list() {
    print_header "Scan Profiles"
    local response=$(api_request GET "/scanning_profiles")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        echo "$response" | jq -r '.scanning_profiles[] | "[\(.profile_id)] \(.name)"'
    fi
}

templates_list() {
    print_header "Report Templates"
    local response=$(api_request GET "/report_templates")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        echo "$response" | jq -r '.templates[] | "[\(.template_id)] \(.name) (\(.group // "General"))"'
    fi
}

groups_list() {
    print_header "Target Groups"
    local response=$(api_request GET "/target_groups")
    
    if [[ "$OUTPUT_FORMAT" == "json" ]]; then
        output "$response"
    else
        echo "$response" | jq -r '.groups[] | "[\(.group_id)] \(.name)"'
    fi
}

info() {
    local response=$(api_request GET "/info")
    output "$response"
}

license_info() {
    local response=$(api_request GET "/license")
    output "$response"
}

# ============== HELP ==============

show_help() {
    cat << 'EOF'

    ___               ___    ____  ____ 
   /   | _______  __ /   |  / __ \/  _/
  / /| |/ ___/ / / // /| | / /_/ // /  
 / ___ / /__/ /_/ // ___ |/ ____// /   
/_/  |_\___/\__,_//_/  |_/_/   /___/   
                                        
EOF
    echo -e "${BLUE}Acunetix CLI v${VERSION}${NC} - Scalable Command Line Interface\n"
    
    echo -e "${GREEN}USAGE:${NC}"
    echo "  acunetix [options] <command> <subcommand> [arguments]"
    echo ""
    
    echo -e "${GREEN}GLOBAL OPTIONS:${NC}"
    echo "  -j, --json          Output in JSON format"
    echo "  -c, --csv           Output in CSV format"
    echo "  -o, --output FILE   Save output to file"
    echo "  -q, --quiet         Suppress info messages"
    echo "  -v, --verbose       Show debug information"
    echo "  -h, --help          Show this help"
    echo "  --version           Show version"
    echo ""
    
    echo -e "${GREEN}COMMANDS:${NC}"
    echo ""
    echo -e "  ${YELLOW}targets${NC}"
    echo "    list                        List all targets"
    echo "    add <url> [desc] [crit]     Add target"
    echo "    info <id>                   Get target details"
    echo "    delete <id>                 Delete target"
    echo "    import <file>               Bulk import from file"
    echo ""
    echo -e "  ${YELLOW}scans${NC}"
    echo "    list                        List all scans"
    echo "    start <target_id> [profile] Start scan"
    echo "    status <scan_id>            Get scan status"
    echo "    results <scan_id>           Get scan statistics"
    echo "    watch <scan_id> [interval]  Watch progress live"
    echo "    stop|pause|resume <id>      Control scan"
    echo "    delete <id>                 Delete scan"
    echo ""
    echo -e "  ${YELLOW}vulns${NC}"
    echo "    list <scan_id> [severity]   List vulnerabilities"
    echo "    info <scan_id> <vuln_id>    Vulnerability details"
    echo "    export <scan_id> <format> [file]"
    echo "                                Export (json|csv|markdown)"
    echo ""
    echo -e "  ${YELLOW}reports${NC}"
    echo "    list                        List reports"
    echo "    generate <scan_id> [tpl]    Generate report"
    echo "    download <id> [file]        Download report"
    echo "    delete <id>                 Delete report"
    echo ""
    echo -e "  ${YELLOW}quick${NC} <url> [profile] [-w]   Add target & scan"
    echo -e "  ${YELLOW}stats${NC}                        Show statistics"
    echo -e "  ${YELLOW}api${NC} <METHOD> <endpoint> [data]  Raw API access"
    echo -e "  ${YELLOW}profiles${NC}                     List scan profiles"
    echo -e "  ${YELLOW}templates${NC}                    List report templates"
    echo -e "  ${YELLOW}info${NC}                         API info"
    echo -e "  ${YELLOW}license${NC}                      License info"
    echo ""
    
    echo -e "${GREEN}EXAMPLES:${NC}"
    echo "  # JSON output"
    echo "  acunetix -j scans list"
    echo "  acunetix --json vulns list abc-123"
    echo ""
    echo "  # Export to file"
    echo "  acunetix -j -o scans.json scans list"
    echo "  acunetix vulns export abc-123 csv findings.csv"
    echo ""
    echo "  # Watch scan progress"
    echo "  acunetix scans watch abc-123"
    echo "  acunetix quick https://example.com -w"
    echo ""
    echo "  # Filter vulnerabilities"
    echo "  acunetix vulns list abc-123 critical"
    echo "  acunetix -j vulns list abc-123 high"
    echo ""
    echo "  # Bulk import targets"
    echo "  acunetix targets import urls.txt"
    echo ""
    echo "  # Raw API access"
    echo "  acunetix api GET /me"
    echo "  acunetix api POST /targets '{\"address\":\"https://example.com\"}'"
    echo ""
}

# ============== MAIN ==============

main() {
    # Parse global options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -j|--json)
                OUTPUT_FORMAT="json"
                shift
                ;;
            -c|--csv)
                OUTPUT_FORMAT="csv"
                shift
                ;;
            -o|--output)
                OUTPUT_FILE="$2"
                shift 2
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            --version)
                echo "acunetix v${VERSION}"
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                log_error "Unknown option: $1"
                exit 1
                ;;
            *)
                break
                ;;
        esac
    done
    
    load_config
    
    local command="${1:-help}"
    local subcommand="${2:-}"
    
    case "$command" in
        targets)
            case "$subcommand" in
                list|ls)    targets_list ;;
                add)        targets_add "$3" "$4" "$5" ;;
                info|get)   targets_info "$3" ;;
                delete|rm)  targets_delete "$3" ;;
                import)     targets_import "$3" ;;
                *)          echo "Usage: acunetix targets <list|add|info|delete|import>" ;;
            esac
            ;;
        scans)
            case "$subcommand" in
                list|ls)    scans_list ;;
                start)      scans_start "$3" "$4" ;;
                status)     scans_status "$3" ;;
                results)    scans_results "$3" ;;
                watch)      scans_watch "$3" "$4" ;;
                stop|abort) scans_stop "$3" ;;
                pause)      scans_pause "$3" ;;
                resume)     scans_resume "$3" ;;
                delete|rm)  scans_delete "$3" ;;
                *)          echo "Usage: acunetix scans <list|start|status|results|watch|stop|pause|resume|delete>" ;;
            esac
            ;;
        vulns|vulnerabilities)
            case "$subcommand" in
                list|ls)    vulns_list "$3" "$4" ;;
                info|get)   vulns_info "$3" "$4" ;;
                export)     vulns_export "$3" "$4" "$5" ;;
                *)          echo "Usage: acunetix vulns <list|info|export>" ;;
            esac
            ;;
        reports)
            case "$subcommand" in
                list|ls)    reports_list ;;
                generate)   reports_generate "$3" "$4" ;;
                download)   reports_download "$3" "$4" ;;
                delete|rm)  reports_delete "$3" ;;
                *)          echo "Usage: acunetix reports <list|generate|download|delete>" ;;
            esac
            ;;
        quick)
            quick_scan "$2" "$3" "$4"
            ;;
        stats|statistics)
            stats
            ;;
        api)
            api_raw "$2" "$3" "$4"
            ;;
        profiles)
            profiles_list
            ;;
        templates)
            templates_list
            ;;
        groups)
            groups_list
            ;;
        info)
            info
            ;;
        license)
            license_info
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            show_help
            ;;
    esac
}

main "$@"
